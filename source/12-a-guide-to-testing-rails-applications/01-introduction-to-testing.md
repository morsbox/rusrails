# Введение в тестирование

Поддержка тестирования встроена в Rails с самого начала. И это не было так: "О! Давайте внесем поддержку запуска тестов, это ново и круто!" Почти каждое приложение на Rails сильно взаимодействует с базой данных, и, как результат, тестам также требуется база данных для работы. Чтобы писать эффективные тесты, следует понять, как настроить эту базу данных и наполнить ее образцом данных.

### Тестовая среда разработки

По умолчанию каждое приложение на Rails имеет три среды разработки: development, test и production. База данных для каждой из них настраивается в `config/database.yml`.

Отдельная тестовая база данных позволяет настраивать и работать с данными в изоляции. Тесты могут искажать тестовые данные с уверенностью, что они не затронут данные в базах данных development или production.

### Настройка Rails для тестирования с нуля

Rails создает папку `test` как только вы создаете проект Rails, используя `rails new _application_name_`. Если посмотрите список содержимого этой папки, то увидите:

```bash
$ ls -F test

fixtures/  functional/  integration/  performance/  test_helper.rb  unit/
```

Директория `unit` предназначена содержать тесты для ваших моделей, директория `functional` предназначена содержать тесты для ваших контроллеров, директория `integration` предназначена содержать тесты, которые включают любое взаимодействие контроллеров, и директория `performance` предназначена для тестов производительности.

Фикстуры это способ организации тестовых данных; они находятся в папке `fixtures`.

Файл `test_helper.rb` содержит конфигурацию по умолчанию для ваших тестов.

### Полная информация по фикстурам

Для хороших тестов необходимо подумать о настройке тестовых данных. В Rails этим можно управлять, определяя и настраивая фикстуры.

#### Что такое фикстуры?

_Fixtures_ это выдуманное слово для образцов данных. Фикстуры позволяют заполнить вашу тестовую базу данных предопределенными данными до запуска тестов. Фикстуры независимы от типа базы данных и написаны на YAML. На каждую модель имеется отдельный файл.

Фикстуры расположены в директории `test/fixtures`. Когда запускаете `rails generate model` для создания новой модели, незаконченные фикстуры будут автоматически созданы и помещены в эту директорию.

#### YAML

Фикстуры в формате YAML являются дружелюбным способом описать Ваш образец данных. Этот тип фикстур имеет расширение файла *.yml* (как в `users.yml`).

Вот образец файла фикстуры YAML:

```yaml
# lo & behold!  I am a YAML comment!
david:
 name: David Heinemeier Hansson
 birthday: 1979-10-15
 profession: Systems development

steve:
 name: Steve Ross Kellock
 birthday: 1974-09-27
 profession: guy with keyboard
```

Каждой фикстуре дается имя со следующим за ним списком с отступом пар ключ/значение, разделенных двоеточием. Записи обычно разделяются пустой строкой. Можете помещать комментарии в файл фикстуры, используя символ # в первом столбце.

#### ERb

ERb позволяет встраивать код Ruby в шаблоны. Формат фикстур YAML предварительно обрабатывается с помощью ERb при загрузке фикстур. Это позволяет использовать Ruby для помощи в создании некоторых образцов данных. Например, следующий код создаст тысячу пользователей:

```erb
<% 1000.times do |n| %>
user_<%= n %>:
  username: <%= "user%03d" % n %>
  email: <%= "user%03d@example.com" % n %>
<% end %>
```

#### Фикстуры в действии

Rails по умолчанию автоматически загружает все фикстуры из папки "test/fixtures" для ваших юнит- и функциональных тестов. Загрузка состоит из трех этапов:

* Убираются любые существующие данные из таблицы, соответствующей фикстуре
* Загружаются данные фикстуры в таблицу
* Выгружаются данные фикстуры в переменную, в случае, если вы хотите обращаться к ним напрямую

#### Фикстуры это объекты ActiveRecord

Фикстуры являются экземплярами ActiveRecord. Как упоминалось в этапе №3 выше, Вы можете обращаться к объекту напрямую, поскольку он автоматически настраивается как локальная переменная для задачи тестирования. Например:

```ruby
# это возвратит объект User для фикстуры с именем david
users(:david)

# это возвратит свойство для david, названное id
users(:david).id

# он имеет доступ к методам, доступным для класса User
email(david.girlfriend.email, david.location_tonight)
```
